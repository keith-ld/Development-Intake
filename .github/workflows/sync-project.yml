name: Sync Intake Form
on:
  issues:
    types: [opened]

jobs:
  sync_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/keith-ld/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      - name: Set Project Fields
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          # The global ID of the Issue itself (starts with 'I_')
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
        run: |
          # 1. Fetch Project ID
          PROJECT_ID=$(gh project list --owner "keith-ld" --format json --jq '.projects[] | select(.number==1) | .id')
          
          # 2. Find the Item ID (the 'PVTI_' ID) by looking up the Issue ID in the project
          # This replaces the failing output from the previous action
          ITEM_ID=$(gh project item-list 1 --owner "keith-ld" --format json --jq ".items[] | select(.content.id==\"$ISSUE_NODE_ID\") | .id")

          # 3. Fetch Field and Option IDs
          FIELD_DATA=$(gh project field-list 1 --owner "keith-ld" --format json)
          FIELD_ID=$(echo "$FIELD_DATA" | jq -r '.fields[] | select(.name=="Workflow Stage") | .id')
          OPTION_ID=$(echo "$FIELD_DATA" | jq -r --arg f_id "$FIELD_ID" '.fields[] | select(.id==$f_id) | .options[] | select(.name=="New Request") | .id')

          # 4. Final Validation
          [[ -z "$PROJECT_ID" ]] && echo "Missing: PROJECT_ID" && exit 1
          [[ -z "$ITEM_ID" ]] && echo "Missing: ITEM_ID (Lookup failed for Issue $ISSUE_NODE_ID)" && exit 1
          [[ -z "$FIELD_ID" ]] && echo "Missing: FIELD_ID" && exit 1
          [[ -z "$OPTION_ID" ]] && echo "Missing: OPTION_ID" && exit 1

          echo "Success: Found Item ID $ITEM_ID. Updating..."

          # 5. Execute GraphQL Mutation
          gh api graphql -f query='
            mutation($project: ID!, $item: ID!, $field: ID!, $option: String!) {
              updateProjectV2ItemFieldValue(input: {
                projectId: $project
                itemId: $item
                fieldId: $field
                value: { singleSelectOptionId: $option }
              }) { projectV2Item { id } }
            }' -f project="$PROJECT_ID" -f item="$ITEM_ID" -f field="$FIELD_ID" -f option="$OPTION_ID"
