name: Sync Intake Form
on:
  issues:
    types: [opened]

jobs:
  sync_project:
    runs-on: ubuntu-latest
    steps:
      # 1. Add the issue to your project board
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        with:
          project-url: https://github.com/users/keith-ld/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      # 2. Parse the YAML form using the IDs
      - name: Parse Issue Body
        uses: zentered/issue-forms-body-parser@v2.2.0
        id: parse
        with:
          body: ${{ github.event.issue.body }}

      # 3. Set the Project Fields using consistent variable names
      - name: Set Project Fields
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ISSUE_ID: ${{ github.event.issue.node_id }}
          # This maps specifically to your 'id: business_value'
          VAL_BUSINESS_VALUE: ${{ fromJson(steps.parse.outputs.data).business_value.text }}
        run: |
          # A. Set Workflow Stage
          gh project item-edit --id "$ISSUE_ID" --project-id 1 --field "Workflow Stage" --value "New Request"

          # B. Business Value Logic (Default to Medium)
          if [ -z "$VAL_BUSINESS_VALUE" ] || [ "$VAL_BUSINESS_VALUE" == "_No response_" ]; then
            FINAL_VAL="Medium"
          else
            FINAL_VAL="$VAL_BUSINESS_VALUE"
          fi

          # C. Update the Project Board
          gh project item-edit --id "$ISSUE_ID" --project-id 1 --field "Business Value" --value "$FINAL_VAL"
