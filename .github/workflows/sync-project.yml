name: Sync Intake Form
on:
  issues:
    types: [opened]

jobs:
  sync_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        id: add_to_project
        with:
          project-url: https://github.com/users/keith-ld/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      - name: Parse Issue Body
        uses: zentered/issue-forms-body-parser@v2.2.0
        id: parse
        with:
          body: ${{ github.event.issue.body }}

      - name: Set Project Fields
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ITEM_ID: ${{ steps.add_to_project.outputs.project-item-id }}
          VAL_BUSINESS_VALUE: ${{ fromJson(steps.parse.outputs.data).business_value.text }}
        run: |
          # 1. Wait 2 seconds for GitHub's database to catch up
          sleep 2

          # 2. Get the Project's Global Node ID
          PROJECT_ID=$(gh project list --owner "keith-ld" --format json --jq '.projects[] | select(.number==1) | .id')
          echo "Debug: Project ID is $PROJECT_ID"

          # 3. Get Field IDs directly using a simplified query
          # We use the project number '1' here as the CLI requires it for field-list
          ID_WORKFLOW_STAGE=$(gh project field-list 1 --owner "keith-ld" --format json --jq '.fields[] | select(.name=="Workflow Stage") | .id')
          ID_BUSINESS_VALUE=$(gh project field-list 1 --owner "keith-ld" --format json --jq '.fields[] | select(.name=="Business Value") | .id')

          echo "Debug: Workflow Field ID: $ID_WORKFLOW_STAGE"
          echo "Debug: Business Value Field ID: $ID_BUSINESS_VALUE"

          # 4. Exit if IDs are missing so we don't send empty strings to GraphQL
          if [ -z "$ID_WORKFLOW_STAGE" ] || [ -z "$ID_BUSINESS_VALUE" ]; then
            echo "Error: One or more Field IDs could not be found."
            exit 1
          fi

          # 5. Set Workflow Stage
          gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$ID_WORKFLOW_STAGE" --text "New Request"

          # 6. Set Business Value (Default to Medium)
          if [ -z "$VAL_BUSINESS_VALUE" ] || [ "$VAL_BUSINESS_VALUE" == "_No response_" ]; then
            FINAL_VAL="Medium"
          else
            FINAL_VAL="$VAL_BUSINESS_VALUE"
          fi
          
          gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$ID_BUSINESS_VALUE" --text "$FINAL_VAL"
