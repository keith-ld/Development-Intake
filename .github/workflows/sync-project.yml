name: Sync Intake Form
on:
  issues:
    types: [opened]

jobs:
  sync_project:
    runs-on: ubuntu-latest
    steps:
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        id: add_to_project
        with:
          project-url: https://github.com/users/keith-ld/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      - name: Parse Issue Body
        uses: zentered/issue-forms-body-parser@v2.2.0
        id: parse
        with:
          body: ${{ github.event.issue.body }}

      - name: Set Project Fields
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          ITEM_ID: ${{ steps.add_to_project.outputs.project-item-id }}
        run: |
          # 1. Get the Project ID
          PROJECT_ID=$(gh project list --owner "keith-ld" --format json --jq '.projects[] | select(.number==1) | .id')

          # 2. Get the Field ID for "Workflow Stage"
          FIELD_DATA=$(gh project field-list 1 --owner "keith-ld" --format json)
          FIELD_ID=$(echo "$FIELD_DATA" | jq -r '.fields[] | select(.name=="Workflow Stage") | .id')

          # 3. Get the Option ID for "New Request" 
          # This is the "missing node" the error was complaining about
          OPTION_ID=$(echo "$FIELD_DATA" | jq -r --arg field_id "$FIELD_ID" '.fields[] | select(.id==$field_id) | .options[] | select(.name=="New Request") | .id')

          echo "Debug: Field ID is $FIELD_ID"
          echo "Debug: Option ID is $OPTION_ID"

          # 4. Update the field using the specific Option ID flag
          gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$FIELD_ID" --single-select-option-id "$OPTION_ID"
