name: Sync Intake Form
on:
  issues:
    types: [opened]

jobs:
  sync_project:
    runs-on: ubuntu-latest
    steps:
      # 1. Link the new issue to the project board
      - name: Add to Project
        uses: actions/add-to-project@v1.0.2
        id: add_to_project
        with:
          project-url: https://github.com/users/keith-ld/projects/1
          github-token: ${{ secrets.PROJECT_TOKEN }}

      # 2. Extract form data using the ID fields from your YAML
      - name: Parse Issue Body
        uses: zentered/issue-forms-body-parser@v2.2.0
        id: parse
        with:
          body: ${{ github.event.issue.body }}

      # 3. Define variables and run the update commands
      - name: Set Project Fields
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
          # This is the ITEM_ID generated by the 'add-to-project' step
          ITEM_ID: ${{ steps.add_to_project.outputs.project-item-id }}
          # This pulls the choice from your YAML form
          VAL_BUSINESS_VALUE: ${{ fromJson(steps.parse.outputs.data).business_value.text }}
        run: |
          # A. Get the Project's Global Node ID
          PROJECT_ID=$(gh project list --owner "keith-ld" --format json --jq '.projects[] | select(.number==1) | .id')

          # B. Get the internal Field IDs for your columns
          PROJECT_DATA=$(gh project field-list 1 --owner "keith-ld" --format json)
          
          ID_WORKFLOW_STAGE=$(echo "$PROJECT_DATA" | jq -r '.fields[] | select(.name=="Workflow Stage") | .id')
          ID_BUSINESS_VALUE=$(echo "$PROJECT_DATA" | jq -r '.fields[] | select(.name=="Business Value") | .id')

          # C. Set Workflow Stage to "New Request" using the ITEM_ID
          gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$ID_WORKFLOW_STAGE" --text "New Request"

          # D. Logic for Business Value: Default to Medium if empty
          if [ -z "$VAL_BUSINESS_VALUE" ] || [ "$VAL_BUSINESS_VALUE" == "_No response_" ]; then
            FINAL_VAL="Medium"
          else
            FINAL_VAL="$VAL_BUSINESS_VALUE"
          fi

          # E. Update the Project Board column using the ITEM_ID
          gh project item-edit --id "$ITEM_ID" --project-id "$PROJECT_ID" --field-id "$ID_BUSINESS_VALUE" --text "$FINAL_VAL"
